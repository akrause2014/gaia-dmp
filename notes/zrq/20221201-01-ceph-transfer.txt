#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2022, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#zrq-notes-time
#zrq-notes-indent
#zrq-notes-crypto
#zrq-notes-ansible
#zrq-notes-osformat
#zrq-notes-zeppelin
#

    Target:

        Test the new deployment.

        TODO:

            Re-instate eDR3 data.
            Rename Manila share from 'aglais-data-gaia-dr3-2048-new' to 'aglais-data-gaia-dr3-2048-20221107'
            Verify to using Nigel's fork of the data schema.
            Compare row counts, max, min, avg with TAP results.

            Run Stelios's concurrent benchmark tests to check.

    Result:

        Done:

            Re-instate eDR3 data.
            Rename Manila share from 'aglais-data-gaia-dr3-2048-new' to 'aglais-data-gaia-dr3-2048-20221107'
            Create a test user and run all of the example notebooks.
            PASS - The deployment can run all of the examples.

        TODO:

            Need to check that eDR3 works.
            Modify some of the tests to explicitly use eDR3 data ?


# -----------------------------------------------------
# Get the details of our new share.
#[root@ansibler]

    # Set the Manila API version.
    # https://stackoverflow.com/a/58806536
    source /deployments/openstack/bin/settings.sh

    sharecloud=iris-gaia-data

    openstack \
        --os-cloud "${sharecloud:?}" \
        share list

    >   +--------------------------------------+---------------------------------+-------+-------------+----------------+-----------+-----------------+------+-------------------+
    >   | ID                                   | Name                            |  Size | Share Proto | Status         | Is Public | Share Type Name | Host | Availability Zone |
    >   +--------------------------------------+---------------------------------+-------+-------------+----------------+-----------+-----------------+------+-------------------+
    >   | c3c83cf6-5897-4194-b150-a29e83022a13 | aglais-data-gaia-dr3-2048       |  4196 | CEPHFS      | available      | False     | ceph01_cephfs   |      | nova              |
    >   | 89467d18-212e-4207-ba67-b3597892186d | aglais-data-gaia-dr3-2048-new   |  8192 | CEPHFS      | available      | False     | ceph01_cephfs   |      | nova              |
    >   | 298ad303-9d81-4540-b4f0-d099ade46be2 | aglais-data-gaia-edr3-2048      |  1024 | CEPHFS      | available      | False     | ceph01_cephfs   |      | nova              |
    >   | 2ec7b3d6-8d70-44a0-9424-9d869f18c0f0 | aglais-data-gaia-edr3-8192      |  1024 | CEPHFS      | error_deleting | False     | ceph01_cephfs   |      | nova              |
    >   | d07a403d-12aa-4b72-9a2e-9136d29721fb | aglais-data-panstarrs-ps1       |   300 | CEPHFS      | available      | False     | ceph01_cephfs   |      | nova              |
    >   | 9faa8e39-ba47-474f-8abd-d6303fb9436e | aglais-data-twomass-allsky      |    40 | CEPHFS      | available      | False     | ceph01_cephfs   |      | nova              |
    >   | 417fb77f-5659-46e3-a074-7c1d7c18a0fe | aglais-data-wise-allwise        |   350 | CEPHFS      | available      | False     | ceph01_cephfs   |      | nova              |
    >   ....
    >   ....
    >   +--------------------------------------+---------------------------------+-------+-------------+----------------+-----------+-----------------+------+-------------------+


# -----------------------------------------------------
# Rename our share to use the create date rather than 'new'.
#[root@ansibler]

    newname=aglais-data-gaia-dr3-2048-20221107
    shareuuid=89467d18-212e-4207-ba67-b3597892186d

    openstack \
        --os-cloud "${sharecloud:?}" \
        share set \
            --name "${newname:?}" \
            "${shareuuid:?}"

    openstack \
        --os-cloud "${sharecloud:?}" \
        share show \
            --format json \
            "${shareuuid:?}"

    >   {
    >     "access_rules_status": "active",
    >     "availability_zone": "nova",
    >     "create_share_from_snapshot_support": false,
    >     "created_at": "2022-11-07T17:20:28.000000",
    >     "description": null,
    >     "export_locations": "\nid = 58e913c8-bde1-4a00-a0f1-71ef73c8e500\npath = 10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/5875b16a-3fd1-489e-a342-d50548e4e522\npreferred = False",
    >     "has_replicas": false,
    >     "id": "89467d18-212e-4207-ba67-b3597892186d",
    >     "is_public": false,
    >     "mount_snapshot_support": false,
    >     "name": "aglais-data-gaia-dr3-2048-20221107",
    >     "project_id": "e216e6b502134b6185380be6ccd0bf09",
    >     "properties": {},
    >     "replication_type": null,
    >     "revert_to_snapshot_support": false,
    >     "share_group_id": null,
    >     "share_network_id": null,
    >     "share_proto": "CEPHFS",
    >     "share_type": "12668f5c-44e4-4b63-abf1-c56002ccc424",
    >     "share_type_name": "ceph01_cephfs",
    >     "size": 8192,
    >     "snapshot_id": null,
    >     "snapshot_support": false,
    >     "source_share_group_snapshot_member_id": null,
    >     "status": "available",
    >     "task_state": null,
    >     "user_id": "5fa0c97a6dd14e01a3c7d91dad5c6b17",
    >     "volume_type": "ceph01_cephfs"
    >   }


# -----------------------------------------------------
# Update our datashares configuration to inclde eDR3, remove the symlinks and remove the unused catalogs.
#[user@desktop]

    source "${HOME:?}/aglais.env"
    pushd "${AGLAIS_CODE}"

        gedit deployments/common/manila/datashares.yaml

            ....
            ....

            #
            # See git commit log for details of the changes.
            #


# -----------------------------------------------------
# Clean deployment.
#[root@ansibler]

    time \
        source /deployments/hadoop-yarn/bin/deploy.sh

    >   aglais:
    >     status:
    >       deployment:
    >         type: hadoop-yarn
    >         conf: zeppelin-54.86-spark-6.26.43
    >         name: iris-gaia-green-20221201
    >         date: 20221201T154805
    >         hostname: zeppelin.gaia-dmp.uk
    >     spec:
    >       openstack:
    >         cloud:
    >           base: arcus
    >           name: iris-gaia-green
    >
    >   real	36m24.499s
    >   user	11m51.687s
    >   sys	2m44.315s


# -----------------------------------------------------
# Login to Zeppelin and check the data is mounted in the right place.
#[root@ansibler]

    ssh zeppelin \
        '
        hostname
        date
        echo ""
        ls -al /data/gaia
        echo ""
        ls -al /data/gaia/GEDR3
        echo ""
        ls -al /data/gaia/GDR3
        echo ""
        du -h -d 1 /data/gaia/GEDR3
        echo ""
        du -h -d 1 /data/gaia/GDR3
        '

    >   iris-gaia-green-20221201-zeppelin
    >   Fri Dec  2 03:14:06 UTC 2022
    >
    >   total 8
    >   drwxr-xr-x.  4 root root 4096 Dec  1 16:20 .
    >   drwxr-xr-x.  3 root root 4096 Dec  1 16:19 ..
    >   drwxrwxrwx. 49 root root   48 Nov 22 07:00 GDR3
    >   dr-xr-xr-x.  6 root root    8 Jan  3  2022 GEDR3

    >   total 6
    >   dr-xr-xr-x. 6 root root    8 Jan  3  2022 .
    >   drwxr-xr-x. 4 root root 4096 Dec  1 16:20 ..
    >   dr-xr-xr-x. 2 root root 2049 May 11  2021 GEDR3_2048_2MASSPSC_BEST_NEIGHBOURS
    >   dr-xr-xr-x. 2 root root 2049 May 11  2021 GEDR3_2048_ALLWISE_BEST_NEIGHBOURS
    >   dr-xr-xr-x. 2 root root 2049 May 11  2021 GEDR3_2048_GAIASOURCE
    >   dr-xr-xr-x. 2 root root 2049 May 11  2021 GEDR3_2048_PS1_BEST_NEIGHBOURS
    >   lrwxrwxrwx. 1 root root   35 May 14  2021 GEDR3_2MASSPSC_BEST_NEIGHBOURS -> GEDR3_2048_2MASSPSC_BEST_NEIGHBOURS
    >   lrwxrwxrwx. 1 root root   34 May 14  2021 GEDR3_ALLWISE_BEST_NEIGHBOURS -> GEDR3_2048_ALLWISE_BEST_NEIGHBOURS
    >   lrwxrwxrwx. 1 root root   21 May 14  2021 GEDR3_GAIASOURCE -> GEDR3_2048_GAIASOURCE
    >   lrwxrwxrwx. 1 root root   30 May 14  2021 GEDR3_PS1_BEST_NEIGHBOURS -> GEDR3_2048_PS1_BEST_NEIGHBOURS

    >   total 5
    >   drwxrwxrwx. 49 root root   48 Nov 22 07:00 .
    >   drwxr-xr-x.  4 root root 4096 Dec  1 16:20 ..
    >   dr-xr-xr-x.  2 root root 2049 Nov 21 13:03 GDR3_2MASSPSC_BEST_NEIGHBOURS
    >   drwxr-xr-x.  2 root root  172 Nov 17 10:18 GDR3_ALERTS_MIXEDIN_SOURCEIDS
    >   dr-xr-xr-x.  2 root root 2049 Nov 21 12:45 GDR3_ALLWISE_BEST_NEIGHBOURS
    >   drwxr-xr-x.  2 root root 4098 Nov 17 10:55 GDR3_ASTROPHYSICAL_PARAMETERS
    >   drwxr-xr-x.  2 root root 4098 Nov 17 11:29 GDR3_ASTROPHYSICAL_PARAMETERS_SUPP
    >   drwxr-xr-x.  2 root root 4098 Nov 17 11:44 GDR3_EPOCH_PHOTOMETRY
    >   lrwxrwxrwx.  1 root root   16 Nov 22 07:00 GDR3_GAIASOURCE -> GDR3_GAIA_SOURCE
    >   drwxr-xr-x.  2 root root 4098 Nov 17 13:39 GDR3_GAIA_SOURCE
    >   drwxr-xr-x.  2 root root 4098 Nov 17 13:41 GDR3_GALAXY_CANDIDATES
    >   drwxr-xr-x.  2 root root 4098 Nov 17 13:42 GDR3_GALAXY_CATALOGUE_NAME
    >   drwxr-xr-x.  2 root root 4098 Nov 17 21:56 GDR3_MCMC_SAMPLES_GSP_PHOT
    >   drwxr-xr-x.  2 root root 4098 Nov 18 01:28 GDR3_MCMC_SAMPLES_MSC
    >   drwxr-xr-x.  2 root root 4098 Nov 18 01:29 GDR3_NSS_ACCELERATION_ASTRO
    >   drwxr-xr-x.  2 root root 4098 Nov 18 01:31 GDR3_NSS_NON_LINEAR_SPECTRO
    >   drwxr-xr-x.  2 root root 4098 Nov 18 01:32 GDR3_NSS_TWO_BODY_ORBIT
    >   drwxr-xr-x.  2 root root 1410 Nov 18 01:33 GDR3_NSS_VIM_FL
    >   drwxr-xr-x.  2 root root    4 Nov 18 01:33 GDR3_OA_NEURON_INFORMATION
    >   drwxr-xr-x.  2 root root 1416 Nov 18 01:33 GDR3_OA_NEURON_XP_SPECTRA
    >   dr-xr-xr-x.  2 root root 2049 Nov 21 11:55 GDR3_PS1_BEST_NEIGHBOURS
    >   drwxr-xr-x.  2 root root 4098 Nov 18 01:35 GDR3_QSO_CANDIDATES
    >   drwxr-xr-x.  2 root root 4098 Nov 18 01:36 GDR3_QSO_CATALOGUE_NAME
    >   drwxr-xr-x.  2 root root 4098 Nov 18 01:43 GDR3_RVS_MEAN_SPECTRUM
    >   drwxr-xr-x.  2 root root 2974 Nov 18 01:44 GDR3_SCIENCE_ALERTS
    >   drwxr-xr-x.  2 root root 4098 Nov 18 01:47 GDR3_SSO_OBSERVATION
    >   drwxr-xr-x.  2 root root 4098 Nov 18 01:49 GDR3_SSO_REFLECTANCE_SPECTRUM
    >   drwxr-xr-x.  2 root root 4098 Nov 18 01:50 GDR3_SSO_SOURCE
    >   drwxr-xr-x.  2 root root 4098 Nov 18 01:51 GDR3_TOTAL_GALACTIC_EXTINCTION_MAP
    >   drwxr-xr-x.  2 root root 4098 Nov 18 01:53 GDR3_TOTAL_GALACTIC_EXTINCTION_MAP_OPT
    >   drwxr-xr-x.  2 root root 4098 Nov 18 01:54 GDR3_VARI_AGN
    >   drwxr-xr-x.  2 root root 4096 Nov 18 01:55 GDR3_VARI_CEPHEID
    >   drwxr-xr-x.  2 root root    4 Nov 18 01:55 GDR3_VARI_CLASSIFIER_CLASS_DEFINITION
    >   drwxr-xr-x.  2 root root    4 Nov 18 01:55 GDR3_VARI_CLASSIFIER_DEFINITION
    >   drwxr-xr-x.  2 root root 4098 Nov 18 01:57 GDR3_VARI_CLASSIFIER_RESULT
    >   drwxr-xr-x.  2 root root 3900 Nov 18 01:58 GDR3_VARI_COMPACT_COMPANION
    >   drwxr-xr-x.  2 root root 4098 Nov 18 02:00 GDR3_VARI_ECLIPSING_BINARY
    >   drwxr-xr-x.  2 root root 4098 Nov 18 02:01 GDR3_VARI_EPOCH_RADIAL_VELOCITY
    >   drwxr-xr-x.  2 root root 4098 Nov 18 02:03 GDR3_VARI_LONG_PERIOD_VARIABLE
    >   drwxr-xr-x.  2 root root  660 Nov 18 02:03 GDR3_VARI_MICROLENSING
    >   drwxr-xr-x.  2 root root 4098 Nov 18 02:04 GDR3_VARI_MS_OSCILLATOR
    >   drwxr-xr-x.  2 root root  418 Nov 18 02:04 GDR3_VARI_PLANETARY_TRANSIT
    >   drwxr-xr-x.  2 root root 2484 Nov 18 02:05 GDR3_VARI_RAD_VEL_STATISTICS
    >   drwxr-xr-x.  2 root root 4098 Nov 18 02:07 GDR3_VARI_ROTATION_MODULATION
    >   drwxr-xr-x.  2 root root 4098 Nov 18 02:08 GDR3_VARI_RRLYRAE
    >   drwxr-xr-x.  2 root root 4098 Nov 18 02:09 GDR3_VARI_SHORT_TIMESCALE
    >   drwxr-xr-x.  2 root root 4098 Nov 18 02:12 GDR3_VARI_SUMMARY
    >   drwxr-xr-x.  2 root root 4098 Nov 18 10:16 GDR3_XP_CONTINUOUS_MEAN_SPECTRUM
    >   drwxr-xr-x.  2 root root 4098 Nov 18 10:35 GDR3_XP_SAMPLED_MEAN_SPECTRUM
    >   drwxr-xr-x.  2 root root 4098 Nov 18 10:40 GDR3_XP_SUMMARY

    >   163G    /data/gaia/GEDR3/GEDR3_2048_PS1_BEST_NEIGHBOURS
    >   60G     /data/gaia/GEDR3/GEDR3_2048_2MASSPSC_BEST_NEIGHBOURS
    >   561G    /data/gaia/GEDR3/GEDR3_2048_GAIASOURCE
    >   177G    /data/gaia/GEDR3/GEDR3_2048_ALLWISE_BEST_NEIGHBOURS
    >   959G    /data/gaia/GEDR3

    >   88M     /data/gaia/GDR3/GDR3_NSS_ACCELERATION_ASTRO
    >   591G    /data/gaia/GDR3/GDR3_GAIA_SOURCE
    >   367M    /data/gaia/GDR3/GDR3_GALAXY_CANDIDATES
    >   60G     /data/gaia/GDR3/GDR3_2MASSPSC_BEST_NEIGHBOURS
    >   62G     /data/gaia/GDR3/GDR3_EPOCH_PHOTOMETRY
    >   50M     /data/gaia/GDR3/GDR3_VARI_CEPHEID
    >   3.0M    /data/gaia/GDR3/GDR3_SCIENCE_ALERTS
    >   5.2M    /data/gaia/GDR3/GDR3_NSS_VIM_FL
    >   17M     /data/gaia/GDR3/GDR3_QSO_CATALOGUE_NAME
    >   303M    /data/gaia/GDR3/GDR3_QSO_CANDIDATES
    >   23M     /data/gaia/GDR3/GDR3_VARI_SHORT_TIMESCALE
    >   165G    /data/gaia/GDR3/GDR3_ASTROPHYSICAL_PARAMETERS_SUPP
    >   19G     /data/gaia/GDR3/GDR3_RVS_MEAN_SPECTRUM
    >   63M     /data/gaia/GDR3/GDR3_TOTAL_GALACTIC_EXTINCTION_MAP
    >   163G    /data/gaia/GDR3/GDR3_PS1_BEST_NEIGHBOURS
    >   2.7T    /data/gaia/GDR3/GDR3_XP_CONTINUOUS_MEAN_SPECTRUM
    >   11M     /data/gaia/GDR3/GDR3_GALAXY_CATALOGUE_NAME
    >   2.6G    /data/gaia/GDR3/GDR3_VARI_SUMMARY
    >   324M    /data/gaia/GDR3/GDR3_VARI_ECLIPSING_BINARY
    >   125M    /data/gaia/GDR3/GDR3_VARI_CLASSIFIER_RESULT
    >   573M    /data/gaia/GDR3/GDR3_VARI_ROTATION_MODULATION
    >   177G    /data/gaia/GDR3/GDR3_ALLWISE_BEST_NEIGHBOURS
    >   8.7M    /data/gaia/GDR3/GDR3_SSO_SOURCE
    >   201M    /data/gaia/GDR3/GDR3_NSS_TWO_BODY_ORBIT
    >   4.0K    /data/gaia/GDR3/GDR3_VARI_CLASSIFIER_DEFINITION
    >   14M     /data/gaia/GDR3/GDR3_NSS_NON_LINEAR_SPECTRO
    >   17M     /data/gaia/GDR3/GDR3_VARI_COMPACT_COMPANION
    >   2.9M    /data/gaia/GDR3/GDR3_OA_NEURON_XP_SPECTRA
    >   1.2T    /data/gaia/GDR3/GDR3_MCMC_SAMPLES_MSC
    >   524K    /data/gaia/GDR3/GDR3_VARI_PLANETARY_TRANSIT
    >   136M    /data/gaia/GDR3/GDR3_VARI_RRLYRAE
    >   4.3G    /data/gaia/GDR3/GDR3_SSO_OBSERVATION
    >   8.1G    /data/gaia/GDR3/GDR3_XP_SUMMARY
    >   268K    /data/gaia/GDR3/GDR3_OA_NEURON_INFORMATION
    >   4.0K    /data/gaia/GDR3/GDR3_VARI_CLASSIFIER_CLASS_DEFINITION
    >   7.2M    /data/gaia/GDR3/GDR3_VARI_EPOCH_RADIAL_VELOCITY
    >   29M     /data/gaia/GDR3/GDR3_VARI_AGN
    >   5.5M    /data/gaia/GDR3/GDR3_VARI_RAD_VEL_STATISTICS
    >   17M     /data/gaia/GDR3/GDR3_SSO_REFLECTANCE_SPECTRUM
    >   2.7T    /data/gaia/GDR3/GDR3_MCMC_SAMPLES_GSP_PHOT
    >   189G    /data/gaia/GDR3/GDR3_ASTROPHYSICAL_PARAMETERS
    >   171K    /data/gaia/GDR3/GDR3_ALERTS_MIXEDIN_SOURCEIDS
    >   9.0M    /data/gaia/GDR3/GDR3_VARI_MS_OSCILLATOR
    >   31M     /data/gaia/GDR3/GDR3_VARI_LONG_PERIOD_VARIABLE
    >   3.0M    /data/gaia/GDR3/GDR3_VARI_MICROLENSING
    >   90G     /data/gaia/GDR3/GDR3_XP_SAMPLED_MEAN_SPECTRUM
    >   45M     /data/gaia/GDR3/GDR3_TOTAL_GALACTIC_EXTINCTION_MAP_OPT
    >   8.0T    /data/gaia/GDR3

    #
    # Looks good.
    #



# -----------------------------------------------------
# Allow port 8080 (HTTP) because HTTPS can't handle test systems.
#[root@ansibler]

    groupid=$(
        openstack \
            --os-cloud "${cloudname:?}" \
            security group list \
                --format json \
        | jq -r '.[] | select(.Name | match("zeppelin-security")) | .ID'
        )

    openstack \
        --os-cloud "${cloudname:?}" \
        security group rule create \
            --ingress \
            --protocol 'tcp' \
            --dst-port '8080:8080' \
            "${groupid}"

    >   +-------------------------+--------------------------------------+
    >   | Field                   | Value                                |
    >   +-------------------------+--------------------------------------+
    >   | created_at              | 2022-12-02T03:24:02Z                 |
    >   | description             |                                      |
    >   | direction               | ingress                              |
    >   | ether_type              | IPv4                                 |
    >   | id                      | c92a2ad5-4a98-4641-be71-ca9154233a49 |
    >   | name                    | None                                 |
    >   | port_range_max          | 8080                                 |
    >   | port_range_min          | 8080                                 |
    >   | project_id              | de5ddc6b4d1e445bb73e45c7b8971673     |
    >   | protocol                | tcp                                  |
    >   | remote_address_group_id | None                                 |
    >   | remote_group_id         | None                                 |
    >   | remote_ip_prefix        | 0.0.0.0/0                            |
    >   | revision_number         | 0                                    |
    >   | security_group_id       | f7cb22f1-ec14-4f79-8bb4-6579287c7518 |
    >   | tags                    | []                                   |
    >   | tenant_id               | de5ddc6b4d1e445bb73e45c7b8971673     |
    >   | updated_at              | 2022-12-02T03:24:02Z                 |
    >   +-------------------------+--------------------------------------+


# -----------------------------------------------------
# Create a test user.
#[root@ansibler]

    source /deployments/zeppelin/bin/create-user-tools.sh

    username=$(pwgen 16 1)

    createusermain "${username}" \
    | tee "/tmp/${username}.json" \
    | jq '.shirouser | {"username": .name, "password": .password}'

    >   {
    >     "username": "Zoh0seedie0hieRu",
    >     "password": "eggplant hydrant pumice partake"
    >   }


# -----------------------------------------------------
# Login as our test user.
#[root@ansibler]

    password=$(
        jq -r '.shirouser.password' "/tmp/${username}.json"
        )

    zeppelinurl=http://zeppelin:8080
    zepcookies=/tmp/${username:?}.cookies

    curl \
        --silent \
        --request 'POST' \
        --cookie-jar "${zepcookies:?}" \
        --data "userName=${username:?}" \
        --data "password=${password:?}" \
        "${zeppelinurl:?}/api/login" \
    | jq '.'

    >   {
    >     "status": "OK",
    >     "message": "",
    >     "body": {
    >       "principal": "Zoh0seedie0hieRu",
    >       "ticket": "a5983744-4159-40eb-87c9-9895d7f98160",
    >       "roles": "[]"
    >     }
    >   }


# -----------------------------------------------------
# List notebooks the user can see.
#[root@ansibler]

    curl \
        --silent \
        --cookie "${zepcookies:?}" \
        "${zeppelinurl:?}/api/notebook" \
    | jq '.'

    >   {
    >     "status": "OK",
    >     "message": "",
    >     "body": [
    >       {
    >         "id": "2HNG5AKA2",
    >         "path": "/Users/Zoh0seedie0hieRu/examples/1. Start here"
    >       },
    >       ....
    >       ....
    >       {
    >         "id": "2HJDX1NES",
    >         "path": "/Users/Zoh0seedie0hieRu/examples/8. Tips and tricks"
    >       }
    >     ]
    >   }


# -----------------------------------------------------
# Run all our examples.
#[root@ansibler]

    source /deployments/zeppelin/bin/zeppelin-rest-tools.sh

    testall \
        "${username}" \
        "${password}" \
        "/Users/${username}/examples" \
    | tee "/tmp/${username}-testone.json" \
    | jq '
       .notebooks[] | {
            "id": .noteid,
            "name": .execute.name,
            "path": .execute.path,
            "duration": .execute.duration,
            "paragraphs": [
                .execute.paragraphs[] | {
                    "title": .title,
                    "status": .execute.status,
                    "code":   .execute.body.code,
                    "duration": .duration
                    }
                ]
            }
       '

    >   {
    >     "id": "2HNG5AKA2",
    >     "name": "1. Start here",
    >     "path": "/Users/Zoh0seedie0hieRu/examples/1. Start here",
    >     "duration": "0:0:38",
    >     "paragraphs": [
    >       {
    >         "title": "Introduction",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:3"
    >       },
    >       {
    >         "title": "Familiarisation",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Zeppelin notebooks",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "PySpark SQL",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Example code from previous cell",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:32"
    >       },
    >       {
    >         "title": "Spark aspects",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Further reading and resources",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       }
    >     ]
    >   }
    >   {
    >     "id": "2HKF5YG6C",
    >     "name": "2. Data holdings",
    >     "path": "/Users/Zoh0seedie0hieRu/examples/2. Data holdings",
    >     "duration": "0:0:15",
    >     "paragraphs": [
    >       {
    >         "title": "Introduction",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Database and table details",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:8"
    >       },
    >       {
    >         "title": "N.B.",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Description and links",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Column listing for a table",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Querying the main catalogue",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:2"
    >       },
    >       {
    >         "title": "Querying with cross-matched data",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:4"
    >       },
    >       {
    >         "title": "Things to note",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       }
    >     ]
    >   }
    >   {
    >     "id": "2HN3JMWUP",
    >     "name": "3. Source counts over the sky",
    >     "path": "/Users/Zoh0seedie0hieRu/examples/3. Source counts over the sky",
    >     "duration": "0:0:57",
    >     "paragraphs": [
    >       {
    >         "title": "null",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Set the resolution level and define the query",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:1"
    >       },
    >       {
    >         "title": "Plot up the results",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:55"
    >       },
    >       {
    >         "title": "Further reading and resources",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "null",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       }
    >     ]
    >   }
    >   {
    >     "id": "2HKWZABYH",
    >     "name": "4. Mean proper motions over the sky",
    >     "path": "/Users/Zoh0seedie0hieRu/examples/4. Mean proper motions over the sky",
    >     "duration": "0:1:51",
    >     "paragraphs": [
    >       {
    >         "title": "Introduction",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Set HEALPix resolution",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Define a data frame by SQL query",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:1"
    >       },
    >       {
    >         "title": "Mean RA proper motion plot",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:1:47"
    >       },
    >       {
    >         "title": "Mean Dec proper motion plot",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:1"
    >       },
    >       {
    >         "title": "Further reading and resources",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:1"
    >       },
    >       {
    >         "title": "Tidy-up",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "null",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       }
    >     ]
    >   }
    >   {
    >     "id": "2HJJDNMGX",
    >     "name": "5. Working with Gaia XP spectra",
    >     "path": "/Users/Zoh0seedie0hieRu/examples/5. Working with Gaia XP spectra",
    >     "duration": "1:50:25",
    >     "paragraphs": [
    >       {
    >         "title": "Introduction",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Sampling and plotting spectra (continuous representation)",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:7"
    >       },
    >       {
    >         "title": "Creating a single, externally calibrated spectrum from BP and RP",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:1"
    >       },
    >       {
    >         "title": "Searching for similar spectra",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Utility code",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:1"
    >       },
    >       {
    >         "title": "Set up the template and selection for the trawl",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:5"
    >       },
    >       {
    >         "title": "Action the trawl and collect the top 3 (for example) matches",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "1:50:9"
    >       },
    >       {
    >         "title": "Plot sampled spectra (internal calibration)",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:1"
    >       },
    >       {
    >         "title": "Plot externally calibrated spectra",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:1"
    >       },
    >       {
    >         "title": "Further information",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       }
    >     ]
    >   }
    >   {
    >     "id": "2HNPENG3Y",
    >     "name": "6. Working with cross-matched surveys",
    >     "path": "/Users/Zoh0seedie0hieRu/examples/6. Working with cross-matched surveys",
    >     "duration": "0:7:39",
    >     "paragraphs": [
    >       {
    >         "title": "Introduction",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Standard platform set-up",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:1"
    >       },
    >       {
    >         "title": "Utility function definitions",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Define a data aggregation",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Collect the results and process in preparation for visualisation",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:7:35"
    >       },
    >       {
    >         "title": "Visualise via matplotlib",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Further reading",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:1"
    >       },
    >       {
    >         "title": "null",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       }
    >     ]
    >   }
    >   {
    >     "id": "2HNN8DDWU",
    >     "name": "7. Good astrometric solutions via ML Random Forest classifier",
    >     "path": "/Users/Zoh0seedie0hieRu/examples/7. Good astrometric solutions via ML Random Forest classifier",
    >     "duration": "0:22:6",
    >     "paragraphs": [
    >       {
    >         "title": "null",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Basic catalogue query selections and predicates",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Raw catalogue with selected columns",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:18:18"
    >       },
    >       {
    >         "title": "Visualisation (colour / absolute-magnitue diagram) of the raw catalogue",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:2"
    >       },
    >       {
    >         "title": "null",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Define the training samples",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:2"
    >       },
    >       {
    >         "title": "Assemble training and reserve test sets",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Train up the Random Forest",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:2:39"
    >       },
    >       {
    >         "title": "Check feature set for nulls",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Classify the reserved test sets",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:1"
    >       },
    >       {
    >         "title": "Classification confusion matrix",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:12"
    >       },
    >       {
    >         "title": "Relative importance of the selected features",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Apply the classification model and plot sample results",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:14"
    >       },
    >       {
    >         "title": "Histogram of classification probability",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:24"
    >       },
    >       {
    >         "title": "Sky distribution of good source sample",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:4"
    >       },
    >       {
    >         "title": "Sky distribution of bad source sample",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:4"
    >       },
    >       {
    >         "title": "Tidy up",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Further reading and resources",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "null",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       }
    >     ]
    >   }
    >   {
    >     "id": "2HJDX1NES",
    >     "name": "8. Tips and tricks",
    >     "path": "/Users/Zoh0seedie0hieRu/examples/8. Tips and tricks",
    >     "duration": "0:0:28",
    >     "paragraphs": [
    >       {
    >         "title": "null",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Resetting the Spark context",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Exporting data from the platform using ssh",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Interpreters",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Getting Python help (PySpark)",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:1"
    >       },
    >       {
    >         "title": "Getting Python help (IPython)",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:4"
    >       },
    >       {
    >         "title": "null",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:15"
    >       },
    >       {
    >         "title": "null",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "null",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:1"
    >       },
    >       {
    >         "title": "Dynamic input forms",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Data frame formatted table display",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "null",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Simple matplotlib example",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Plotting from multiple cells in matplotlib",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "First cell - this has the plot with the first line",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Second line",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:1"
    >       },
    >       {
    >         "title": "Label axes",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Add legend",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Add title",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "null",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "null",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:1"
    >       }
    >     ]
    >   }

    #
    # Passes the tests, but 'feels' slower that I would expect.
    # 18 min to select the subset for the forest classifier ?
    #
    # Seeing a lot of errors and failed nodes in the Spark interpreter log.
    # Suspect this config doesn't have Stelios's magic number applied to it.
    #


# -----------------------------------------------------
# Try running just one example.
#[root@ansibler]

    source /deployments/zeppelin/bin/zeppelin-rest-tools.sh

    testall \
        "${username}" \
        "${password}" \
        "/Users/${username}/examples/7" \
    | tee "/tmp/${username}-testone.json" \
    | jq '
       .notebooks[] | {
            "id": .noteid,
            "name": .execute.name,
            "path": .execute.path,
            "duration": .execute.duration,
            "paragraphs": [
                .execute.paragraphs[] | {
                    "title": .title,
                    "status": .execute.status,
                    "code":   .execute.body.code,
                    "duration": .duration
                    }
                ]
            }
       '

    >   {
    >     "id": "2HNN8DDWU",
    >     "name": "7. Good astrometric solutions via ML Random Forest classifier",
    >     "path": "/Users/Zoh0seedie0hieRu/examples/7. Good astrometric solutions via ML Random Forest classifier",
    >     "duration": "0:10:45",
    >     "paragraphs": [
    >       {
    >         "title": "null",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Basic catalogue query selections and predicates",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Raw catalogue with selected columns",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:6:50"
    >       },
    >       {
    >         "title": "Visualisation (colour / absolute-magnitue diagram) of the raw catalogue",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:2"
    >       },
    >       {
    >         "title": "null",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Define the training samples",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:3"
    >       },
    >       {
    >         "title": "Assemble training and reserve test sets",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:1"
    >       },
    >       {
    >         "title": "Train up the Random Forest",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:2:43"
    >       },
    >       {
    >         "title": "Check feature set for nulls",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Classify the reserved test sets",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Classification confusion matrix",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:13"
    >       },
    >       {
    >         "title": "Relative importance of the selected features",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Apply the classification model and plot sample results",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:14"
    >       },
    >       {
    >         "title": "Histogram of classification probability",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:24"
    >       },
    >       {
    >         "title": "Sky distribution of good source sample",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:5"
    >       },
    >       {
    >         "title": "Sky distribution of bad source sample",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:5"
    >       },
    >       {
    >         "title": "Tidy up",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "Further reading and resources",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       },
    >       {
    >         "title": "null",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:0:0"
    >       }
    >     ]
    >   }

    #
    # Better, closer to what I would expect.
    #


    #
    # When executed as part of the full sequence of examples the data selection takes 18min.
    #

    >       ....
    >       {
    >         "title": "Raw catalogue with selected columns",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:18:18"
    >       },
    >       ....


    #
    # When run as a single test on its own, the same cell takes ~7min.
    #

    >       ....
    >       {
    >         "title": "Raw catalogue with selected columns",
    >         "status": "OK",
    >         "code": "SUCCESS",
    >         "duration": "0:6:50"
    >       },
    >       ....

    #
    # Not what we are testing here though.
    # Yes, test passes.
    # The deployment can run all of the examples.
    #

